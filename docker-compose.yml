services:
  app:
    build: .
    ports:
      - "80:80"
      - "443:443"
    environment:
      APP_NAME: ephishchk
      APP_ENV: production
      APP_DEBUG: "false"
      APP_TIMEZONE: UTC
      SECURE_COOKIES: "true"
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-change-this-to-a-random-32-character-string}
      DB_DRIVER: mysql
      DB_HOST: db
      DB_PORT: "3306"
      DB_DATABASE: ephishchk
      DB_USERNAME: ephishchk
      DB_PASSWORD: ${DB_PASSWORD:-ephishchk_secret}
      DNS_CACHE_TTL: "300"
      MAX_EMAIL_SIZE: "10485760"
      MAX_ATTACHMENT_SIZE: "33554432"
      SERVER_NAME: ${SERVER_NAME:-localhost}
    volumes:
      - app-storage:/var/www/ephishchk/storage
      # Mount custom SSL certs (optional - self-signed generated if absent)
      # - ./certs/ephishchk.crt:/etc/ssl/certs/ephishchk.crt:ro
      # - ./certs/ephishchk.key:/etc/ssl/private/ephishchk.key:ro
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  db:
    image: mariadb:11
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_secret}
      MARIADB_DATABASE: ephishchk
      MARIADB_USER: ephishchk
      MARIADB_PASSWORD: ${DB_PASSWORD:-ephishchk_secret}
    volumes:
      - db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  db-data:
  app-storage:
